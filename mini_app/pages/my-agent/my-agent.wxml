<!--pages/my-agent/my-agent.wxml-->
<view class="container">
  <!-- 代理信息卡片 -->
  <view class="agent-info-card">
    <view class="agent-level">
      <text class="level-badge {{userInfo.agentLevel === 1 ? 'level1' : 'level2'}}">{{userInfo.agentLevel === 1 ? '一级代理' : userInfo.agentLevel === 2 ? '二级代理' : '普通会员'}}
      </text>
    </view>
    <view class="agent-stats">
      <view class="stat-item">
        <text class="stat-value">{{statistics.totalCommission || 0}}</text>
        <text class="stat-label">累计收益(元)</text>
      </view>
      <view class="stat-item" wx:if="{{userInfo.agentLevel === 1}}">
        <text class="stat-value">{{statistics.subAgentCount || 0}}</text>
        <text class="stat-label">下级代理</text>
      </view>
      <!-- 下级会员统计已隐藏 -->
    </view>

    <!-- 邀请码 -->
    <view class="invite-section" wx:if="{{userInfo.inviteCode}}">
      <text class="invite-label">我的邀请码</text>
      <view class="invite-code-box">
        <text class="invite-code">{{userInfo.inviteCode}}</text>
        <button class="copy-btn" size="mini" bindtap="copyInviteCode">复制</button>
      </view>
    </view>

    <!-- 快捷操作 -->
    <view class="quick-actions">
      <view class="action-btn" bindtap="goToCommissionApply">
        <view class="action-icon-wrap">
          <text class="action-icon-text">$</text>
        </view>
        <text class="action-text">返现申请</text>
      </view>
      <view class="action-btn" bindtap="shareInvite">
        <view class="action-icon-wrap">
          <text class="action-icon-text">↗</text>
        </view>
        <text class="action-text">邀请好友</text>
      </view>
      <view class="action-btn" wx:if="{{userInfo.agentLevel === 1}}" bindtap="showInviteDialog">
        <view class="action-icon-wrap">
          <text class="action-icon-text">+</text>
        </view>
        <text class="action-text">邀请代理</text>
      </view>
    </view>
  </view>

  <!-- Tab切换 -->
  <view class="tabs">
    <view class="tab-item {{activeTab === 'agents' ? 'active' : ''}}" bindtap="switchTab" data-tab="agents" wx:if="{{userInfo.agentLevel === 1}}">
      下级代理 ({{agentList.length}})
    </view>
    <!-- 下级会员tab已隐藏 -->
    <view class="tab-item {{activeTab === 'applications' ? 'active' : ''}}" bindtap="switchTab" data-tab="applications" wx:if="{{userInfo.agentLevel === 1}}">
      邀请申请 ({{inviteApplications.length}})
    </view>
  </view>

  <!-- 下级代理列表 -->
  <view class="team-list" wx:if="{{activeTab === 'agents' && userInfo.agentLevel === 1}}">
    <block wx:if="{{agentList.length > 0}}">
      <view class="team-item" wx:for="{{agentList}}" wx:key="id">
        <view class="member-header">
          <view class="member-info">
            <image class="avatar" src="{{item.avatarUrl || 'https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0'}}" mode="aspectFill"></image>
            <view class="member-details">
              <view class="member-name">{{item.nickname || '用户' + item.id}}</view>
              <view class="member-meta">
                <text class="type-badge agent">{{item.agentLevel === 2 ? '二级代理' : '一级代理'}}</text>
                <text class="meta-text" wx:if="{{item.commissionRate}}">返现: {{item.commissionRate}}%</text>
              </view>
            </view>
          </view>
          <view class="member-earnings">
            <text class="earnings-value">¥{{item.totalCommissionAmount || '0.00'}}</text>
            <text class="earnings-label">累计收益</text>
          </view>
        </view>
        <view class="member-footer">
          <view class="footer-item">
            <text class="footer-label">加入时间</text>
            <text class="footer-value">{{item.createTime}}</text>
          </view>
          <view class="footer-item" wx:if="{{item.phone}}">
            <text class="footer-label">手机号</text>
            <text class="footer-value">{{item.phone}}</text>
          </view>
        </view>
      </view>
    </block>

    <view class="empty-state" wx:else>
      <view class="empty-icon-wrap">
        <text class="empty-icon-text">空</text>
      </view>
      <text class="empty-text">暂无下级代理</text>
      <text class="empty-tip" wx:if="{{userInfo.agentLevel === 1}}">点击上方"邀请代理"开始邀请</text>
    </view>
  </view>

  <!-- 下级会员列表（已隐藏） -->
  <!--
  <view class="team-list" wx:if="{{activeTab === 'members'}}">
    <block wx:if="{{memberList.length > 0}}">
      <view class="team-item" wx:for="{{memberList}}" wx:key="id">
        <view class="member-header">
          <view class="member-info">
            <image class="avatar" src="{{item.avatarUrl || 'https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0'}}" mode="aspectFill"></image>
            <view class="member-details">
              <view class="member-name">{{item.nickname || '用户' + item.id}}</view>
              <view class="member-meta">
                <text class="type-badge {{item.userType === 2 ? 'vip' : 'normal'}}">{{item.userType === 2 ? '星享会员' : '普通会员'}}
                </text>
              </view>
            </view>
          </view>
          <view class="member-consume">
            <text class="consume-value">¥{{item.totalConsumeAmount || '0.00'}}</text>
            <text class="consume-label">累计消费</text>
          </view>
        </view>
        <view class="member-footer">
          <view class="footer-item">
            <text class="footer-label">加入时间</text>
            <text class="footer-value">{{item.createTime}}</text>
          </view>
          <view class="footer-item" wx:if="{{item.phone}}">
            <text class="footer-label">手机号</text>
            <text class="footer-value">{{item.phone}}</text>
          </view>
        </view>
      </view>
    </block>

    <view class="empty-state" wx:else>
      <view class="empty-icon-wrap">
        <text class="empty-icon-text">空</text>
      </view>
      <text class="empty-text">暂无下级会员</text>
      <text class="empty-tip">邀请用户注册后会显示在这里</text>
    </view>
  </view>
  -->

  <!-- 邀请申请列表 -->
  <view class="team-list" wx:if="{{activeTab === 'applications'}}">
    <block wx:if="{{inviteApplications.length > 0}}">
      <view class="application-item" wx:for="{{inviteApplications}}" wx:key="id">
        <view class="application-header">
          <view class="application-user">
            <text class="user-name">{{item.inviteeNickname || '未知用户'}}</text>
            <text class="user-phone">{{item.inviteePhone}}</text>
          </view>
          <view class="status-badge status-{{item.status}}">
            {{item.statusText}}
          </view>
        </view>

        <view class="application-details">
          <view class="detail-row">
            <view class="detail-item">
              <text class="detail-label">返现比例</text>
              <text class="detail-value">{{item.commissionRate}}%</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">申请时间</text>
              <text class="detail-value">{{item.createTime}}</text>
            </view>
          </view>
          <view class="detail-row" wx:if="{{item.reviewTime}}">
            <view class="detail-item">
              <text class="detail-label">审核时间</text>
              <text class="detail-value">{{item.reviewTime}}</text>
            </view>
          </view>
          <view class="detail-row" wx:if="{{item.status === 2 && item.rejectReason}}">
            <view class="detail-item full-width">
              <text class="detail-label">拒绝原因</text>
              <text class="detail-value reject-reason">{{item.rejectReason}}</text>
            </view>
          </view>
        </view>
      </view>
    </block>

    <view class="empty-state" wx:else>
      <view class="empty-icon-wrap">
        <text class="empty-icon-text">空</text>
      </view>
      <text class="empty-text">暂无邀请申请</text>
      <text class="empty-tip">邀请二级代理后将在此显示审核状态</text>
    </view>
  </view>

  <!-- 邀请二级代理弹窗 -->
  <view class="invite-modal" wx:if="{{showInviteModal}}">
    <view class="modal-mask" bindtap="hideInviteDialog"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">邀请二级代理</text>
        <text class="modal-close" bindtap="hideInviteDialog">✕</text>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <text class="form-label">手机号</text>
          <input
            class="form-input"
            type="number"
            maxlength="11"
            placeholder="请输入对方手机号"
            value="{{invitePhone}}"
            bindinput="onPhoneInput"
          />
        </view>
        <view class="form-item">
          <text class="form-label">返现比例(%)</text>
          <input
            class="form-input"
            type="digit"
            placeholder="请输入返现比例(0-100)"
            value="{{inviteCommissionRate}}"
            bindinput="onCommissionRateInput"
          />
        </view>
        <view class="form-tips">
          <text>提示：可以邀请普通会员或星享会员成为二级代理</text>
        </view>
      </view>
      <view class="modal-footer">
        <button class="cancel-btn" bindtap="hideInviteDialog">取消</button>
        <button class="confirm-btn" bindtap="confirmInvite">确认邀请</button>
      </view>
    </view>
  </view>
</view>
