<!--pages/order-detail/order-detail.wxml-->
<view class="container">
  <view wx:if="{{loading}}" class="loading-wrapper">
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <view wx:else class="detail-content">
    <!-- è®¢å•çŠ¶æ€æç¤º -->
    <view class="status-banner {{order.statusClass}}">
      <text class="status-icon">
        <text wx:if="{{order.orderStatus === 0}}">â°</text>
        <text wx:elif="{{order.orderStatus === 1}}">ğŸ“¦</text>
        <text wx:elif="{{order.orderStatus === 2}}">ğŸšš</text>
        <text wx:elif="{{order.orderStatus === 3}}">âœ…</text>
        <text wx:elif="{{order.orderStatus === 4}}">âŒ</text>
      </text>
      <view class="status-info">
        <text class="status-text">{{order.statusText}}</text>
        <text class="status-tip">{{order.statusTip}}</text>
      </view>
    </view>

    <!-- è®¢å•è¿›åº¦ (éå·²å–æ¶ˆè®¢å•æ˜¾ç¤º) -->
    <view wx:if="{{order.orderStatus !== 4}}" class="progress-section">
      <view class="progress-steps">
        <view class="step-item {{step >= 0 ? 'active' : ''}}">
          <view class="step-circle">
            <text class="step-number" wx:if="{{step < 0}}">1</text>
            <text class="step-check" wx:else>âœ“</text>
          </view>
          <text class="step-label">ä¸‹å•</text>
        </view>

        <view class="step-line {{step >= 1 ? 'active' : ''}}"></view>

        <view class="step-item {{step >= 1 ? 'active' : ''}}">
          <view class="step-circle">
            <text class="step-number" wx:if="{{step < 1}}">2</text>
            <text class="step-check" wx:else>âœ“</text>
          </view>
          <text class="step-label">æ”¯ä»˜</text>
        </view>

        <view class="step-line {{step >= 2 ? 'active' : ''}}"></view>

        <view class="step-item {{step >= 2 ? 'active' : ''}}">
          <view class="step-circle">
            <text class="step-number" wx:if="{{step < 2}}">3</text>
            <text class="step-check" wx:else>âœ“</text>
          </view>
          <text class="step-label">å‘è´§</text>
        </view>

        <view class="step-line {{step >= 3 ? 'active' : ''}}"></view>

        <view class="step-item {{step >= 3 ? 'active' : ''}}">
          <view class="step-circle">
            <text class="step-number" wx:if="{{step < 3}}">4</text>
            <text class="step-check" wx:else>âœ“</text>
          </view>
          <text class="step-label">å®Œæˆ</text>
        </view>
      </view>
    </view>

    <!-- ç‰©æµä¿¡æ¯ (å·²å‘è´§æˆ–å·²å®Œæˆæ—¶æ˜¾ç¤º) -->
    <view wx:if="{{(order.orderStatus === 2 || order.orderStatus === 3) && (order.expressCompany || order.expressNo)}}" class="logistics-section">
      <view class="section-title">ç‰©æµä¿¡æ¯</view>
      <view class="logistics-content">
        <view wx:if="{{order.expressCompany}}" class="logistics-row">
          <text class="label">å¿«é€’å…¬å¸:</text>
          <text class="value">{{order.expressCompany}}</text>
        </view>
        <view wx:if="{{order.expressNo}}" class="logistics-row">
          <text class="label">å¿«é€’å•å·:</text>
          <text class="value">{{order.expressNo}}</text>
          <text class="copy-btn" bindtap="copyExpressNo">å¤åˆ¶</text>
        </view>
        <view wx:if="{{order.shipTime}}" class="logistics-row">
          <text class="label">å‘è´§æ—¶é—´:</text>
          <text class="value">{{order.shipTime}}</text>
        </view>
        <view wx:if="{{order.shipRemark}}" class="logistics-row">
          <text class="label">å‘è´§å¤‡æ³¨:</text>
          <text class="value">{{order.shipRemark}}</text>
        </view>
        <view wx:if="{{order.packageBeforeImage || order.packageAfterImage}}" class="logistics-photos">
          <text class="label">æ‰“åŒ…ç…§ç‰‡:</text>
          <view class="photos-list">
            <image
              wx:if="{{order.packageBeforeImage}}"
              class="photo-item"
              src="{{order.packageBeforeImage}}"
              mode="aspectFill"
              bindtap="previewImage"
              data-url="{{order.packageBeforeImage}}"
            />
            <image
              wx:if="{{order.packageAfterImage}}"
              class="photo-item"
              src="{{order.packageAfterImage}}"
              mode="aspectFill"
              bindtap="previewImage"
              data-url="{{order.packageAfterImage}}"
            />
          </view>
        </view>
      </view>
    </view>

    <!-- æ”¶è´§åœ°å€ -->
    <view class="address-section">
      <view class="section-title">æ”¶è´§ä¿¡æ¯</view>
      <view class="address-content">
        <view class="receiver-info">
          <text class="receiver-name">{{order.receiverName}}</text>
          <text class="receiver-phone">{{order.receiverPhone}}</text>
        </view>
        <view class="address-detail">
          {{order.receiverAddress}}
        </view>
      </view>
    </view>

    <!-- å•†å“åˆ—è¡¨ -->
    <view class="products-section">
      <view class="section-title">å•†å“ä¿¡æ¯</view>
      <view class="products-list">
        <view
          wx:for="{{order.items}}"
          wx:key="id"
          class="product-item"
        >
          <image class="product-image" src="{{item.productImage}}" mode="aspectFill" />
          <view class="product-info">
            <text class="product-name">{{item.productName}}</text>
            <text class="product-spec" wx:if="{{item.specName}}">{{item.specName}}</text>
            <view class="price-row">
              <text class="price">Â¥{{item.productPrice}}</text>
              <text class="quantity">x{{item.quantity}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ä»·æ ¼æ˜ç»† -->
    <view class="price-section">
      <view class="section-title">ä»·æ ¼æ˜ç»†</view>
      <view class="price-details">
        <view class="price-row">
          <text class="label">å•†å“æ€»é¢</text>
          <text class="value">Â¥{{order.totalAmount}}</text>
        </view>
        <view wx:if="{{order.discountAmount > 0}}" class="price-row">
          <text class="label">VIPä¼˜æƒ </text>
          <text class="value deduct">-Â¥{{order.discountAmount}}</text>
        </view>
        <view wx:if="{{order.integralAmount > 0}}" class="price-row">
          <text class="label">ç§¯åˆ†æŠµæ‰£</text>
          <text class="value deduct">-Â¥{{order.integralAmount}}</text>
        </view>
        <view wx:if="{{order.useIntegral > 0}}" class="price-row">
          <text class="label">ä½¿ç”¨ç§¯åˆ†</text>
          <text class="value">{{order.useIntegral}}ç§¯åˆ†</text>
        </view>
        <view class="price-row">
          <text class="label">è¿è´¹</text>
          <text wx:if="{{order.freightAmount > 0}}" class="value">Â¥{{order.freightAmount}}</text>
          <text wx:else class="value free">å…è¿è´¹</text>
        </view>
        <view class="price-row total">
          <text class="label">å®ä»˜é‡‘é¢</text>
          <text class="value amount">Â¥{{order.payAmount}}</text>
        </view>
      </view>
    </view>

    <!-- è®¢å•ä¿¡æ¯ -->
    <view class="order-info-section">
      <view class="section-title">è®¢å•ä¿¡æ¯</view>
      <view class="order-info-list">
        <view class="info-row">
          <text class="label">è®¢å•å·</text>
          <view class="value-with-copy">
            <text class="value">{{order.orderNo}}</text>
            <text class="copy-btn" bindtap="copyOrderNo">å¤åˆ¶</text>
          </view>
        </view>
        <view class="info-row">
          <text class="label">ä¸‹å•æ—¶é—´</text>
          <text class="value">{{order.createTime}}</text>
        </view>
        <view wx:if="{{order.payTime}}" class="info-row">
          <text class="label">æ”¯ä»˜æ—¶é—´</text>
          <text class="value">{{order.payTime}}</text>
        </view>
        <view wx:if="{{order.remark}}" class="info-row">
          <text class="label">è®¢å•å¤‡æ³¨</text>
          <text class="value">{{order.remark}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
  <view wx:if="{{!loading}}" class="footer-actions">
    <view class="action-buttons">
      <!-- å¾…ä»˜æ¬¾çŠ¶æ€ -->
      <block wx:if="{{order.orderStatus === 0}}">
        <button class="btn cancel-btn" bindtap="cancelOrder">å–æ¶ˆè®¢å•</button>
        <button class="btn pay-btn" bindtap="payOrder">å»æ”¯ä»˜</button>
      </block>

      <!-- å¾…å‘è´§çŠ¶æ€ -->
      <block wx:if="{{order.orderStatus === 1}}">
        <button class="btn contact-btn" bindtap="contactService">è”ç³»å®¢æœ</button>
      </block>

      <!-- å¾…æ”¶è´§çŠ¶æ€ -->
      <block wx:if="{{order.orderStatus === 2}}">
        <button class="btn contact-btn" bindtap="contactService">è”ç³»å®¢æœ</button>
        <button class="btn confirm-btn" bindtap="confirmReceipt">ç¡®è®¤æ”¶è´§</button>
      </block>

      <!-- å·²å®ŒæˆçŠ¶æ€ -->
      <block wx:if="{{order.orderStatus === 3}}">
        <button class="btn contact-btn" bindtap="contactService">è”ç³»å®¢æœ</button>
      </block>
    </view>
  </view>
</view>
