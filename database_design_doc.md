# 高端云南水果销售小程序 - 数据库设计文档

## 📋 目录
1. [设计原则](#设计原则)
2. [表结构说明](#表结构说明)
3. [索引设计](#索引设计)
4. [数据字典](#数据字典)
5. [业务流程说明](#业务流程说明)

---

## 🎯 设计原则

本数据库设计严格遵循**阿里巴巴MySQL开发规范**，具体包括：

### 1. 命名规范
- ✅ **表名**：小写字母 + 下划线，不超过32个字符
- ✅ **字段名**：小写字母 + 下划线，见名知意
- ✅ **索引命名**：
  - 主键索引：`PRIMARY KEY`
  - 唯一索引：`uk_字段名`
  - 普通索引：`idx_字段名`
  - 复合索引：`idx_字段1_字段2`

### 2. 字段规范
- ✅ 所有表必须包含：`id`、`create_time`、`update_time`、`is_deleted`
- ✅ 主键统一使用 `BIGINT UNSIGNED AUTO_INCREMENT`
- ✅ 金额字段使用 `DECIMAL(10,2)`
- ✅ 状态字段使用 `TINYINT UNSIGNED`
- ✅ 时间字段使用 `DATETIME`
- ✅ 所有字段必须添加 `COMMENT` 注释

### 3. 存储规范
- ✅ 使用 `InnoDB` 存储引擎
- ✅ 字符集统一使用 `utf8mb4`
- ✅ 排序规则使用 `utf8mb4_unicode_ci`
- ✅ 不使用外键约束（通过应用层保证数据一致性）

### 4. 性能优化
- ✅ 合理创建索引，避免冗余索引
- ✅ 控制单表数据量，订单表可按年分表
- ✅ 大字段（TEXT）独立存储或使用JSON格式
- ✅ 使用复合索引优化高频查询

---

## 📊 表结构说明

### 1️⃣ 用户相关表（3张）

#### user_info - 用户基础信息表
**核心字段说明：**
- `user_type`：用户类型（1-普通会员，2-星享会员，3-一级代理，4-二级代理）
- `commission_rate`：返现比例（一级代理由后台设定，二级代理由上级一级代理指定）
- `parent_agent_id`：上级代理ID（构建代理层级关系）
- `invite_code`：代理专用邀请码

**业务逻辑：**
- 注册时默认为普通会员（user_type=1）
- 充值199元可升级为星享会员（user_type=2）
- 代理必须为星享会员
- 代理层级关系确定后永久生效

#### user_address - 用户收货地址表
**核心字段说明：**
- `is_default`：是否默认地址
- `address_tag`：地址标签（家、公司、学校等）

#### agent_apply - 代理申请记录表
**核心字段说明：**
- `apply_type`：申请类型（1-一级代理，2-二级代理）
- `recommender_id`：推荐人ID（二级代理必须有一级代理推荐）
- `apply_status`：申请状态（0-待审批，1-已通过，2-已拒绝）

---

### 2️⃣ 商品相关表（2张）

#### product_category - 商品分类表
**核心字段说明：**
- `parent_id`：父分类ID（支持多级分类）
- `sort_order`：排序序号

#### product_info - 商品信息表
**核心字段说明：**
- `price`：普通价格
- `vip_price`：星享会员价格（95折）
- `max_buy_count`：最大购买数量（限购）
- `is_recommend`：是否首页推荐

---

### 3️⃣ 订单相关表（3张）

#### order_info - 订单主表
**核心字段说明：**
- `order_status`：订单状态
  - 0-待付款
  - 1-待发货
  - 2-已发货（发货端填写单号后自动变更）
  - 3-已完成（后台手动确认）
  - 4-已取消
- `integral_used`：使用积分数量
- `integral_deduct_amount`：积分抵扣金额
- `is_commission_settled`：是否已结算返现（订单完成后才结算）

**业务规则：**
- 使用积分购物时不计算代理返现
- 只有订单状态为"已完成"时才触发返现结算

#### order_item - 订单商品明细表
**冗余字段说明：**
为提高查询性能，冗余了商品名称、图片等字段，避免关联查询

#### order_logistics - 订单物流表
**核心字段说明：**
- `express_company`：快递公司
- `express_no`：快递单号
- `package_before_image`：包装前照片
- `package_after_image`：包装后照片
- `confirm_admin_id`：确认完成的管理员ID
- `confirm_time`：确认完成时间

**业务规则：**
- 发货时必须上传2张照片
- 订单完成需要后台管理员手动确认

---

### 4️⃣ 返现相关表（1张）

#### commission_record - 返现记录表
**核心字段说明：**
- `agent_level`：代理层级（1-一级代理，2-二级代理）
- `commission_rate`：返现比例（记录下单时的比例）
- `settle_status`：结算状态（0-待结算，1-已结算）

**返现规则：**
```
举例：订单金额100元，一级代理返现10%，二级代理返现5%
- 总返现池：100 × 10% = 10元
- 二级代理获得：100 × 5% = 5元
- 一级代理获得：10 - 5 = 5元
```

---

### 5️⃣ 积分相关表（2张）

#### integral_record - 积分流水表
**核心字段说明：**
- `change_type`：变动类型
  - 1-充值（兑换码）
  - 2-消费获得
  - 3-分享奖励
  - 4-抵扣消费
  - 5-管理员调整
- `balance_before`/`balance_after`：变动前后余额（便于对账）

#### integral_card - 积分充值卡表
**核心字段说明：**
- `card_code`：16位兑换码
- `card_status`：卡状态（0-未使用，1-已使用，2-已过期）
- `batch_no`：批次号（便于批量管理）

---

### 6️⃣ 分享相关表（1张）

#### share_record - 分享记录表
**核心字段说明：**
- `is_converted`：是否转化成功
- `reward_integral`：奖励积分（商品总额的5%）
- `is_rewarded`：是否已发放奖励

**分享规则：**
- 仅星享会员和代理可分享
- 分享链接成交后获得商品总额5%的积分

---

### 7️⃣ 其他表（5张）

#### shopping_cart - 购物车表
标准购物车设计，支持多规格商品

#### system_config - 系统配置表
存储系统全局配置，如VIP价格、折扣比例、返现规则等

#### banner_config - 轮播图配置表
支持图片和视频类型，可配置跳转链接

#### admin_user - 管理员表
支持多角色：超级管理员、普通管理员、发货员

#### product_review - 商品评价表
支持星级评分、图片评价、商家回复

---

## 🔍 索引设计

### 单列索引
所有主键、外键、状态字段均已建立索引

### 复合索引（高频查询优化）
```sql
-- 用户订单查询
idx_order_user_status (user_id, order_status, create_time)

-- 订单时间范围查询
idx_order_time_status (create_time, order_status)

-- 代理返现查询
idx_commission_agent_settle (agent_user_id, settle_status, create_time)

-- 用户积分流水查询
idx_integral_user_time (user_id, create_time)

-- 分享转化查询
idx_share_user_convert (sharer_user_id, is_converted, create_time)
```

### 唯一索引
- 所有编号字段（order_no、user_no等）
- 手机号、微信openid
- 邀请码、兑换码

---

## 📖 数据字典

### 用户类型枚举
| 值 | 说明 |
|---|---|
| 1 | 普通会员 |
| 2 | 星享会员 |
| 3 | 一级代理 |
| 4 | 二级代理 |

### 订单状态枚举
| 值 | 说明 | 触发条件 |
|---|---|---|
| 0 | 待付款 | 用户下单 |
| 1 | 待发货 | 支付成功 |
| 2 | 已发货 | 发货端填写单号 |
| 3 | 已完成 | 后台手动确认 |
| 4 | 已取消 | 用户/系统取消 |

### 积分变动类型枚举
| 值 | 说明 |
|---|---|
| 1 | 充值（兑换码） |
| 2 | 消费获得 |
| 3 | 分享奖励 |
| 4 | 抵扣消费 |
| 5 | 管理员调整 |

---

## 🔄 业务流程说明

### 订单流程
```
1. 用户下单 → order_status = 0（待付款）
2. 支付成功 → order_status = 1（待发货）
3. 发货端发货 → order_status = 2（已发货）+ 填写物流信息
4. 后台确认 → order_status = 3（已完成）→ 触发返现/积分结算
```

### 返现结算流程
```
1. 订单状态变更为"已完成"
2. 检查是否使用积分抵扣
3. 如果未使用积分：
   - 计算返现金额
   - 插入commission_record记录
   - 更新代理用户total_commission_amount
4. 如果使用积分：不计算返现
```

### 代理层级关系
```
一级代理（后台指定）
└── 二级代理1（推荐+审批）
    └── 普通会员A
    └── 星享会员B
└── 二级代理2
    └── 普通会员C
```

---

## 💡 优化建议

### 1. 分表策略
- **订单表**：按年分表（order_info_2024、order_info_2025）
- **积分流水**：按月分表或归档历史数据

### 2. 缓存策略
- 商品信息、分类信息 → Redis缓存
- 用户基础信息 → Redis缓存（TTL: 30分钟）
- 系统配置 → 应用启动时加载到内存

### 3. 读写分离
- 主库：写操作
- 从库：查询操作（订单列表、商品列表等）

### 4. 监控指标
- 慢查询日志
- 索引使用率
- 表数据量增长趋势
- 锁等待时间

---

## 🔒 数据安全

### 1. 敏感信息加密
- 用户手机号：脱敏显示（138****5678）
- 管理员密码：BCrypt加密
- 微信openid/unionid：不对外暴露

### 2. 软删除
所有表使用 `is_deleted` 字段实现软删除，保留数据可追溯性

### 3. 审计日志
重要操作建议记录操作日志表（可选）：
- 管理员操作记录
- 代理设置返现比例记录
- 订单状态变更记录

---

## 📌 注意事项

1. **金额计算**：所有金额计算使用 `DECIMAL` 类型，避免浮点数精度问题
2. **时区处理**：统一使用服务器时区，建议设置为 `Asia/Shanghai`
3. **事务处理**：订单创建、返现结算等关键操作必须使用事务
4. **并发控制**：库存扣减使用乐观锁或悲观锁
5. **定期备份**：每日全量备份 + 实时binlog备份

---

## 📞 联系方式

如有疑问，请联系技术团队。

**最后更新时间：** 2024-09-30
